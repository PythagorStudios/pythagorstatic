/**
 * Created by finn on 1/25/15.
 */
/** Library of Utility commands for Pythagor Studios**/
var express = require('express');
var mysql = require('mysql');
var MD5 = require("MD5");

//Create connection information
module.exports.connectionData = {
    host     : 'localhost',
    user     : 'nodejs',
    password : '<SECRET>'
};

module.exports.getDbName = function() {
    return this.connectionData.database;
};

module.exports.query = function(string, callback) {
    var connection = mysql.createConnection(this.connectionData);

    connection.connect(function (err) {
        if (err) {
            throw "Could not connect to mysql: " + err;
            callback(null, null);
        }
        connection.query(string, function (err, rows, fields) {
            console.log("Queried mysql: " + string);
            connection.end();
            callback(rows, fields);
        });
    });
};

module.exports.createLogin = function(username, password, callback) {
    var salt = Math.round(Math.random() * 1000);
    var util = this;
    util.query("INSERT INTO Login ( username, hash, salt, note ) VALUES ( '" + username + "', '" + MD5(password + salt) + "', " + salt + ", 'Type Note Here' );", function(rows, fields) {
        if (rows == null)
        {

        }
        else
        {
            util.query("SELECT userId FROM Login WHERE username='" + username + "';", function(rows, fields) {
                if (rows == null)
                {
                    console.log("mysql error (#1) while checking login id");
                }
                else if (rows.length == 0)
                {
                    console.log("mysql error (#2) while checking login id");
                }
                else
                {
                    callback(rows[0].userId);
                }
            });
        }
    });
};

module.exports.verifyLogin = function(username, password, callback) {
    this.query("SELECT * FROM Login WHERE username = '" + username + "';", function(rows, fields) {
        if (rows == null)
        {
            console.log("Mysql error while verifying login")
            callback(null);
        }
        else if (rows.length == 0)
        {
            console.log("No such user: " + username)
            callback(null);
        }
        else {
            salt = rows[0].salt;
            if (rows[0].hash == MD5(password + salt)) {
                console.log("Login Succeeded: " + username);
                callback(rows[0].userId);
            }
            else {
                console.log("Login Failed: " + username);
                callback(null)
            }
        }
    });
};

module.exports.getAllOtherLogins = function(userId, callback) {
    this.query("SELECT * FROM Login WHERE userId !=" + userId + ";", function(rows, fields) {
        if (rows == null)
        {
            console.log("Mysql error while getting other logins")
            callback(null);
        }
        else {
            callback(rows);
        }
    });
};

module.exports.deleteLogin = function() {
    console.log("Cannot remove a login. That feature is not available!!!")
};

module.exports.createSession = function(userId, callback) {
    var session = String(MD5(Date.now() + Math.round(Math.random() * 1000))).substring(0, 10);
    this.query("INSERT INTO Session ( userId, session, date ) VALUES ( " + userId + ", '" + session + "', '" + (new Date().toYMD()) + "' );", function(rows, fields) {
        callback(session);
    });
};

module.exports.verifySession = function(session, callback) {
    this.query("SELECT * FROM Session WHERE session = '" + session + "';", function(rows, fields) {
        if (rows == null) {
            console.log("Redirected to login due to mysql problem while getting session");
        }
        else if (rows.length == 0) {
            console.log("No such session, bad login (session: " + session + " )")
            callback(null);
        }
        else {
            callback(rows[0].userId);
        }
    });
};

module.exports.getSession = function(userId, callback) {
    this.query("SELECT session FROM Session where userId=" + userId + " LIMIT 1;", function(rows, fields) {
       if (rows == null)
       {
           console.log("Mysql problems while finding session");
       }
       else if (rows.length == 0)
       {
           callback(null);
       }
       else
       {
           callback(rows[0].session);
       }
    });
};

module.exports.deleteSession = function(session) {
    this.query("DELETE FROM Session WHERE session = '" + session + "' ;", function(rows, fields) {

    });
};

module.exports.getUserId = function(username, callback) {
    this.query("SELECT userId from Login WHERE username='" + username + "';", function(rows, fields) {
        if (rows == null)
        {
            console.log("Mysql error while geting userId");
        }
        else if (rows.length == 0)
        {
            callback(null);
        }
        else {
            callback(rows.userId);
        }
    });
};

module.exports.getUserName = function(userId, callback) {
    this.query("SELECT username FROM Login WHERE userId=" + userId + ";", function(rows, fields) {
        if (rows == null)
        {
            console.log("Mysql error while geting username");
        }
        else if (rows.length == 0)
        {
            callback(null);
        }
        else {
            callback(rows.username);
        }
    });
};

module.exports.getSqlDateNow = function() {
    return new Date().toYMD();
};

module.exports.getSqlDate = function(date) {
    return date.toYMD();
};